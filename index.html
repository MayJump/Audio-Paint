index.html
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Audio Paint â€” Mic or Tab Audio</title>
<style>
  :root { color-scheme: dark; }
  html, body { height:100%; margin:0; background:#0b0d10; overflow:hidden; }
  canvas#scene { position:fixed; inset:0; width:100vw; height:100vh; display:block; z-index:0; }
  .hud{
    position:fixed; left:12px; right:12px; bottom:12px;
    display:flex; justify-content:space-between; align-items:flex-end;
    pointer-events:none; font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#aab2c0; opacity:.92; z-index:2;
  }
  .hud .left{pointer-events:auto; display:flex; flex-wrap:wrap; gap:6px;}
  .chip{
    background:#11161caa; border:1px solid #1e2a35; border-radius:10px;
    padding:8px 10px; backdrop-filter:blur(6px);
  }
  button.chip { cursor:pointer; pointer-events:auto; }
  .muted { opacity:.7 }
  #msg { position:fixed; top:12px; left:12px; color:#ffb4b4; font:12px system-ui; z-index:3; }
</style>
</head>
<body>
<canvas id="scene"></canvas>
<div id="msg"></div>

<div class="hud">
  <div class="left">
    <button class="chip" id="micBtn">ðŸŽ¤ Enable Mic</button>
    <button class="chip" id="tabBtn">ðŸªŸ Use Tab Audio</button>
    <span class="chip muted">M = mic toggle</span>
    <span class="chip muted">R = reseed</span>
    <span class="chip muted">C = palette</span>
    <span class="chip muted">P = pause</span>
    <span class="chip muted">S = save PNG</span>
  </div>
  <div class="chip" id="fps">â€¦</div>
</div>

<script>
/* ========= SETTINGS (longer trails, nice glow) ========= */
const SETTINGS = {
  density: 0.0025,
  step: 1.4,           // more distance per frame
  lineWidth: 0.8,
  noiseScale: 0.0011,
  fieldSpeed: 0.32,
  fadeAlpha: 0.015,    // slower fade = longer streaks
  bg: "#0b0d10",
  palettes: [
    ["#A7C7E7","#6EB5FF","#6B9AC4","#E9F1FF","#C1FFD7"],
    ["#FF6B6B","#FFD93D","#6BCB77","#4D96FF","#B983FF"],
    ["#00C2FF","#00FFC6","#7CFFCB","#F7F7FF","#BDB2FF"],
    ["#F94144","#F3722C","#F8961E","#90BE6D","#577590"],
    ["#D1E8E2","#9AD1D4","#6EC5E9","#C490D1","#845EC2"]
  ]
};
const SUBSTEPS = 3;   // micro-steps per frame for silky trails
/* ======================================================= */

const TAU = Math.PI*2;
let seed = (Math.random()*1e9)|0;
let paused = false;

const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d', { alpha: false });
let W=0, H=0, particles=[], palette = pick(SETTINGS.palettes);

const micBtn = document.getElementById('micBtn');
const tabBtn = document.getElementById('tabBtn');
const msgEl  = document.getElementById('msg');

let audio = {
  ctx: null,
  analyser: null,
  data: null,
  enabled: false,
  fallback: true,
  level: 0
};

function start(){
  resize();
  reseed();
  requestAnimationFrame(loop);
}
if (document.readyState === "loading") addEventListener('DOMContentLoaded', start); else start();

/* ---------- Audio: Mic ---------- */
async function enableMic(){
  try{
    if(!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    useAudioStream(stream, "Mic: ON");
  }catch(e){
    msg("Mic permission denied. Using fallback.");
    audio.enabled = false; audio.fallback = true;
  }
}
function toggleMic(){
  if(!audio.ctx || !audio.analyser){ enableMic(); }
  else { audio.enabled = !audio.enabled; audio.fallback = !audio.enabled; msg(audio.enabled?"Mic: ON":"Mic: OFF"); }
}

/* ---------- Audio: Tab (Chrome/Edge) ---------- */
/* Chrome often omits audio if you ask for audio-only. Ask for video+audio,
   then immediately stop the video track. Select 'Chrome Tab' + check 'Share tab audio'. */
async function enableTabAudio(){
  try{
    if(!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)();

    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: true,   // needed to get the Chrome Tab picker reliably
      audio: true
    });

    const aTracks = stream.getAudioTracks ? stream.getAudioTracks() : [];
    if (!aTracks || aTracks.length === 0) {
      msg("No tab audio track was shared. Pick 'Chrome Tab' and check 'Share tab audio'.");
      stream.getVideoTracks().forEach(t => t.stop());
      return;
    }

    // We don't need the video; stop it so the share UI goes away
    stream.getVideoTracks().forEach(t => t.stop());

    useAudioStream(stream, "Tab audio connected âœ”");
  }catch(e){
    msg("Tab audio not available/denied. Use Chrome/Edge â†’ pick a tab â†’ check 'Share tab audio'.");
  }
}

/* ---------- Common: use audio stream ---------- */
function useAudioStream(stream, label){
  const source = (audio.ctx.createMediaStreamSource(stream));
  audio.analyser = audio.ctx.createAnalyser();
  audio.analyser.fftSize = 1024;
  audio.data = new Uint8Array(audio.analyser.frequencyBinCount);
  source.connect(audio.analyser);
  audio.enabled = true;
  audio.fallback = false;
  msg(label);
}

/* ---------- UI ---------- */
micBtn.addEventListener('click', enableMic);
tabBtn.addEventListener('click', enableTabAudio);

/* ---------- Core viz ---------- */
function reseed(){
  seed = (Math.random()*1e9)|0;
  palette = pick(SETTINGS.palettes);
  const count = Math.max(200, Math.floor(W*H*SETTINGS.density));
  particles = new Array(count).fill(0).map(()=>({
    x: Math.random()*W, y: Math.random()*H, hue: pick(palette), life: 0
  }));
  clear(true);
}

function clear(hard=false){
  ctx.globalAlpha = 1;
  ctx.fillStyle = SETTINGS.bg;
  ctx.fillRect(0,0,W,H);
  if(!hard){
    const n = 4000;
    ctx.globalAlpha = 0.04;
    for(let i=0;i<n;i++){
      const x = Math.random()*W, y=Math.random()*H;
      ctx.fillStyle = Math.random() < 0.5 ? "#0b0d10" : "#0c0f13";
      ctx.fillRect(x,y,1,1);
    }
  }
  ctx.globalAlpha = 1;
}

function loop(t){
  sampleAudio();

  if(!paused){
    // long trails
    const fadeBoost = lerp(SETTINGS.fadeAlpha, SETTINGS.fadeAlpha*0.8, audio.level);
    ctx.globalAlpha = fadeBoost;
    ctx.fillStyle = SETTINGS.bg;
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 1;

    // glow that pulses with volume
    ctx.shadowColor = 'rgba(255,255,255,0.12)';
    ctx.shadowBlur = 8 + audio.level * 20;

    ctx.lineWidth = SETTINGS.lineWidth * (1 + audio.level*1.1);
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';

    const stepBase = SETTINGS.step * (1 + audio.level*1.4);
    const z = t * 0.001 * (SETTINGS.fieldSpeed * (1 + audio.level*0.6));

    ctx.globalCompositeOperation = 'lighter';
    for (let p of particles) {
      let ax = p.x, ay = p.y;
      const stepLen = stepBase / SUBSTEPS;

      for (let s = 0; s < SUBSTEPS; s++) {
        const angle = valueNoise(p.x*SETTINGS.noiseScale, p.y*SETTINGS.noiseScale, z) * TAU*2;
        const nx = p.x + Math.cos(angle) * stepLen;
        const ny = p.y + Math.sin(angle) * stepLen;

        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(nx, ny);
        ctx.strokeStyle = withAlpha(p.hue, 0.06 + 0.12*Math.random()*(0.6 + audio.level*0.4));
        ctx.stroke();

        p.x = nx; p.y = ny;
      }

      p.life++;
      if (p.x< -10 || p.x>W+10 || p.y<-10 || p.y>H+10 || p.life>1500){
        p.x = Math.random()*W; p.y = Math.random()*H; p.hue = pick(palette); p.life = 0;
      }
    }
    ctx.globalCompositeOperation = 'source-over';
    ctx.shadowBlur = 0;
  }
  fpsMeter(t);
  requestAnimationFrame(loop);
}

/* ---------- Audio sampling ---------- */
function sampleAudio(){
  if(audio.enabled && audio.analyser && audio.data){
    audio.analyser.getByteFrequencyData(audio.data);
    const len = audio.data.length, start = Math.floor(len*0.1), end = Math.floor(len*0.85);
    let sumSq = 0, n=0; for(let i=start;i<end;i++){ const v = audio.data[i]/255; sumSq += v*v; n++; }
    const rms = Math.sqrt(sumSq/Math.max(1,n));
    audio.level = audio.level*0.65 + rms*0.35;
  }else{
    const t = performance.now()*0.001;
    audio.level = (Math.sin(t*1.2)*0.5 + 0.5) * 0.35; // graceful fallback
  }
}

/* ----- Value Noise (seeded) ----- */
function valueNoise(x, y, z=0){
  const xi = Math.floor(x), yi = Math.floor(y), zi = Math.floor(z);
  const xf = x - xi, yf = y - yi, zf = z - zi;
  const u = fade(xf), v = fade(yf), w = fade(zf);
  const aaa = hash3(xi,yi,zi), aab = hash3(xi,yi,zi+1);
  const aba = hash3(xi,yi+1,zi), abb = hash3(xi,yi+1,zi+1);
  const baa = hash3(xi+1,yi,zi), bab = hash3(xi+1,yi,zi+1);
  const bba = hash3(xi+1,yi+1,zi), bbb = hash3(xi+1,yi+1,zi+1);
  const x1 = lerp(aaa, baa, u), x2 = lerp(aba, bba, u), y1 = lerp(x1, x2, v);
  const x3 = lerp(aab, bab, u), x4 = lerp(abb, bbb, u), y2 = lerp(x3, x4, v);
  return lerp(y1, y2, w);
}
function hash3(x, y, z){
  let h = x*374761393 + y*668265263 + z*1442695041 + seed;
  h = (h ^ (h >> 13)) * 1274126177; h ^= h >> 16;
  return (h >>> 0) / 4294967295;
}
const fade = t => t*t*t*(t*(t*6-15)+10);
const lerp = (a,b,t)=>a+(b-a)*t;

/* ----- Utils ----- */
function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
function withAlpha(hex, a){
  const {r,g,b} = hexToRGB(hex);
  return `rgba(${r},${g},${b},${a})`;
}
function hexToRGB(hex){
  hex = hex.replace('#','');
  if(hex.length===3){ hex = hex.split('').map(c=>c+c).join(''); }
  const num = parseInt(hex,16);
  return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
}
function msg(s){ msgEl.textContent = s || ""; }

/* ----- Size handling ----- */
function resize(){
  const w = Math.floor(window.innerWidth);
  const h = Math.floor(window.innerHeight);
  canvas.width = w; canvas.height = h;
  canvas.style.width = w + "px"; canvas.style.height = h + "px";
  W = w; H = h;
}
addEventListener('resize', resize);

/* ----- Keys ----- */
addEventListener('keydown', (e)=>{
  if(e.key==='m' || e.key==='M') toggleMic();
  if(e.key==='r' || e.key==='R') reseed();
  if(e.key==='c' || e.key==='C'){ palette = pick(SETTINGS.palettes); }
  if(e.key==='p' || e.key==='P') paused = !paused;
  if(e.key==='s' || e.key==='S') savePNG();
});
function savePNG(){ const a=document.createElement('a'); a.download='audio-paint.png'; a.href=canvas.toDataURL('image/png'); a.click(); }

/* ----- FPS meter ----- */
let last=0, acc=0, frames=0;
function fpsMeter(t){
  const el = document.getElementById('fps');
  const dt = t-last; last=t; acc+=dt; frames++;
  if(acc>500){
    el.textContent = (1000*frames/acc).toFixed(0) + " fps â€¢ " + particles.length + " pts" + (audio.enabled? " â€¢ audio":" â€¢ fallback");
    acc=0; frames=0;
  }
}
</script>
</body>
</html>
